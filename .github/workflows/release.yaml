name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set ENV
      run: |
        sudo timedatectl set-timezone "Asia/Shanghai"
        [ ! -f module/bin ] && mkdir module/bin
        echo "buildSha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - uses: pnpm/action-setup@v4
      name: Setup pnpm
      with:
        version: 10
        run_install: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22.2'

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b
        add-to-path: true

    - name: Install zip
      uses: montudor/action-zip@v1

    - name: Install UPX
      uses: crazy-max/ghaction-upx@v3
      with:
        install-only: true

    - name: Pack module
      run: |
        make CC=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang

    - name: Upload release
      uses: softprops/action-gh-release@v1
      with:
          tag_name: ${{ github.ref_name }}
          files: akashaProxy.zip
          generate_release_notes: true
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}